<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>AR Gallery Pro - Final Fixed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="js/aframe-ar.min.js"></script>
    <script src="js/ar.js"></script>
    <script src="js/mediapipe/selfie_segmentation.js" defer></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; overflow: hidden; background-color: #000; color: white; user-select: none; }
        
        /* Ù„Ø§ÛŒÙ‡ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .ui-hidden #ui-layer { opacity: 0; pointer-events: none; }

        .pointer-auto { pointer-events: auto; }
        
        .ui-top-bar { padding: 15px; display: flex; justify-content: space-between; }
        .ui-bottom-controls { padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); display: flex; flex-direction: column; gap: 10px; }
        
        .btn-icon { background: rgba(45, 45, 45, 0.9); border: 1px solid #555; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; pointer-events: auto; }
        .active-mode { background: #2563eb !important; border-color: #60a5fa !important; }
        
        /* Ø¯Ú©Ù…Ù‡ Ø¢Ø´Ú©Ø§Ø±Ø³Ø§Ø²ÛŒ Ù…Ø®ØµÙˆØµ AR */
        #temp-reveal-btn { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: #2563eb; color: white; border-radius: 20px;
            display: none; border: none; font-weight: bold; pointer-events: auto;
        }

        #custom-ar-btn {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            padding: 15px 30px; background: #2563eb; color: white; border-radius: 30px;
            border: none; font-weight: bold; z-index: 2000; cursor: pointer;
        }

        .hidden { display: none !important; }
        input[type=range] { width: 100%; pointer-events: auto; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; padding: 20px; box-sizing: border-box; pointer-events: auto; }
    </style>
</head>
<body>

    <button id="custom-ar-btn">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø§Ù„Øª AR</button>

    <a-scene 
        embedded 
        ar="takeOverCamera: true" 
        vr-mode-ui="enabled: false"
        renderer="antialias: false; precision: lowp; powerPreference: low-power; alpha: true; fpsLimit: 30"
        webxr="optionalFeatures: dom-overlay; overlayElement: #ui-layer">
        
        <a-entity id="content-entity" position="0 0 -1"></a-entity>
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    </a-scene>

    <div id="ui-layer">
        <button id="temp-reveal-btn">Ø¢Ø´Ú©Ø§Ø±Ø³Ø§Ø²ÛŒ Ù…Ù†ÙˆÙ‡Ø§</button>

        <div class="ui-top-bar">
            <button id="exit-btn" class="btn-icon pointer-auto" style="background:#dc2626;">âœ•</button>
            <button id="clean-view-btn" class="btn-icon pointer-auto">ğŸ‘</button>
        </div>

        <div class="ui-bottom-controls">
            <div id="sliders" class="hidden">
                <input type="range" id="dist-slider" min="0.5" max="5" step="0.1" value="1">
            </div>
            
            <div style="display:flex; gap:10px; justify-content: center;">
                <label class="btn-icon pointer-auto" style="width: auto; padding: 0 15px; border-radius: 10px;">
                    Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„
                    <input type="file" id="file-input" accept="video/*,image/*" style="display:none;">
                </label>
                <button id="cube-shape-btn" class="btn-icon">ğŸ“¦</button>
                <button id="stretch-btn" class="btn-icon">â†”</button>
                <button id="rotate-btn" class="btn-icon">ğŸ”„</button>
                <button id="remove-bg-btn" class="btn-icon">ğŸ‘¤</button>
            </div>
        </div>
    </div>

    <script>
        const sceneEl = document.querySelector('a-scene');
        const contentEntity = document.querySelector('#content-entity');
        const customArBtn = document.getElementById('custom-ar-btn');
        let currentMesh = null;
        let isCubeMode = false;
        let isStretchMode = false;
        let isBgRemovalActive = false;

        // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ AR - Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Û± Ùˆ Ûµ
        customArBtn.addEventListener('click', () => {
            // ÙˆØ±ÙˆØ¯ Ø±Ø³Ù…ÛŒ Ø¨Ù‡ Ø­Ø§Ù„Øª AR Ø§Ø² Ø·Ø±ÛŒÙ‚ A-Frame Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† Ùˆ Ø³Ù†Ø³ÙˆØ±Ù‡Ø§
            sceneEl.enterVR(); 
            customArBtn.style.display = 'none';
            // Ø§Ø¹Ù…Ø§Ù„ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø±Ø® ÙØ±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø§Øº Ø´Ø¯Ù†
            sceneEl.renderer.setPixelRatio(0.7); 
        });

        // Ø®Ø±ÙˆØ¬ Ø§Ø² AR
        document.getElementById('exit-btn').addEventListener('click', () => {
            sceneEl.exitVR();
            customArBtn.style.display = 'block';
        });

        // Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            document.getElementById('sliders').classList.remove('hidden');
            
            if (file.type.startsWith('image')) {
                const loader = new THREE.TextureLoader();
                loader.load(url, tex => createObject(tex, tex.image.width / tex.image.height));
            } else {
                const video = document.createElement('video');
                video.src = url; video.loop = true; video.muted = false; video.play();
                video.onloadedmetadata = () => createObject(new THREE.VideoTexture(video), video.videoWidth / video.videoHeight);
            }
        });

        function createObject(texture, aspect) {
            if (currentMesh) contentEntity.removeObject3D('mesh');
            const geometry = new THREE.PlaneGeometry(aspect, 1);
            const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide, transparent: true });
            currentMesh = new THREE.Mesh(geometry, material);
            contentEntity.setObject3D('mesh', currentMesh);
            currentMesh.userData.aspect = aspect;
        }

        // ØªØºÛŒÛŒØ± Ø¨Ù‡ Ù…Ú©Ø¹Ø¨ - Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Û´
        document.getElementById('cube-shape-btn').addEventListener('click', function() {
            if (!currentMesh) return;
            isCubeMode = !isCubeMode;
            this.classList.toggle('active-mode', isCubeMode);
            const asp = currentMesh.userData.aspect;
            currentMesh.geometry.dispose();
            currentMesh.geometry = isCubeMode ? new THREE.BoxGeometry(asp, 1, 0.2) : new THREE.PlaneGeometry(asp, 1);
        });

        // Ø³ÛŒØ³ØªÙ… ØªØ¹Ø§Ù…Ù„ AR (Ø­Ø±Ú©ØªØŒ Ø²ÙˆÙ…ØŒ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ²) - Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Û³ Ùˆ Û´
        let initialDist = 0;
        let initialScale = new THREE.Vector3();

        window.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                initialScale.copy(contentEntity.object3D.scale);
            }
        });

        window.addEventListener('touchmove', (e) => {
            if (!contentEntity) return;
            
            // Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø¨Ø§ ÛŒÚ© Ø§Ù†Ú¯Ø´Øª
            if (e.touches.length === 1 && !e.target.closest('.pointer-auto')) {
                const touch = e.touches[0];
                contentEntity.object3D.position.x += (touch.deltaX || 0) * 0.01;
                contentEntity.object3D.position.y -= (touch.deltaY || 0) * 0.01;
            }

            // Ø²ÙˆÙ… Ùˆ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ø¢Ø²Ø§Ø¯ Ø¨Ø§ Ø¯Ùˆ Ø§Ù†Ú¯Ø´Øª
            if (e.touches.length === 2) {
                const currentDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                const factor = currentDist / initialDist;

                if (isStretchMode) {
                    const dx = Math.abs(e.touches[0].pageX - e.touches[1].pageX);
                    const dy = Math.abs(e.touches[0].pageY - e.touches[1].pageY);
                    
                    if (dx > dy) contentEntity.object3D.scale.x = initialScale.x * factor;
                    else contentEntity.object3D.scale.y = initialScale.y * factor;
                } else {
                    contentEntity.object3D.scale.set(initialScale.x * factor, initialScale.y * factor, initialScale.z * factor);
                }
            }
        });

        // Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ø¢Ø²Ø§Ø¯
        document.getElementById('stretch-btn').addEventListener('click', function() {
            isStretchMode = !isStretchMode;
            this.classList.toggle('active-mode', isStretchMode);
        });

        // Ù¾Ù†Ù‡Ø§Ù† Ùˆ Ø¢Ø´Ú©Ø§Ø± Ø³Ø§Ø²ÛŒ - Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Û²
        document.getElementById('clean-view-btn').addEventListener('click', () => {
            document.body.classList.add('ui-hidden');
            document.getElementById('temp-reveal-btn').style.display = 'block';
        });

        document.getElementById('temp-reveal-btn').addEventListener('click', () => {
            document.body.classList.remove('ui-hidden');
            document.getElementById('temp-reveal-btn').style.display = 'none';
        });

        // Ú†Ø±Ø®Ø´
        document.getElementById('rotate-btn').addEventListener('click', () => {
            if (contentEntity) contentEntity.object3D.rotation.z += Math.PI / 2;
        });

        // Ø§Ø³Ù„Ø§ÛŒØ¯Ø± ÙØ§ØµÙ„Ù‡
        document.getElementById('dist-slider').addEventListener('input', (e) => {
            contentEntity.object3D.position.z = -e.target.value;
        });
    </script>
</body>
</html>