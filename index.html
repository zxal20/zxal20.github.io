<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>AR Gallery Pro - Rebuilt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    
    <link href="css/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <script src="js/aframe.min.js"></script>
    <script src="js/aframe-ar.js"></script>
    <script src="js/mediapipe/selfie_segmentation.js" defer></script>
    
    <style>
        /* تنظیمات پایه */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; /* پیش‌فرض مشکی */
            font-family: 'Vazirmatn', sans-serif;
            color: white;
            user-select: none;
        }

        /* --- مدیریت نمایش دوربین AR --- */
        /* وقتی کلاس ar-active روی body نیست، همه چیز مربوط به AR مخفی شود */
        body:not(.ar-active) #ar-scene-container { display: none !important; }
        body:not(.ar-active) .a-canvas { display: none !important; }
        body:not(.ar-active) video { display: none !important; } /* مخفی کردن دوربین */
        
        /* وقتی AR فعال است، پس‌زمینه شفاف شود تا دوربین دیده شود */
        body.ar-active { background-color: transparent !important; }
        body.ar-active #non-ar-preview { display: none !important; } /* مخفی کردن پیش‌نمایش معمولی */

        /* --- کانتینر پیش‌نمایش معمولی (غیر AR) --- */
        #non-ar-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            background: #000;
        }
        #preview-media {
            max-width: 100%;
            max-height: 80%;
            object-fit: contain;
        }

        /* --- لایه رابط کاربری (UI) --- */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* دکمه‌های قابل کلیک */
        .pointer-events-auto { pointer-events: auto; }

        .top-bar { padding: 20px; display: flex; justify-content: space-between; }
        .bottom-controls { 
            padding: 20px; 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            align-items: center;
        }

        /* استایل دکمه‌ها */
        .btn-icon {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }
        .btn-icon:active { transform: scale(0.95); background: rgba(37, 99, 235, 0.8); }
        
        .btn-primary {
            background: #2563eb;
            color: white;
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: bold;
            border: none;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            display: flex; align-items: center; gap: 8px;
        }

        #enter-ar-btn {
            position: absolute;
            bottom: 100px;
            right: 30px;
            z-index: 30;
            pointer-events: auto;
        }

        /* اسلایدرها */
        .slider-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }
        input[type=range] { width: 100%; accent-color: #2563eb; }

        .hidden { display: none !important; }
    </style>
</head>
<body id="app-body">

    <div id="non-ar-preview">
        <p id="placeholder-text" style="color: #666;">لطفا یک فایل انتخاب کنید</p>
        <img id="img-preview" class="hidden" src="" style="max-width:100%; max-height:80%;">
        <video id="video-preview" class="hidden" src="" playsinline loop muted style="max-width:100%; max-height:80%;"></video>
    </div>

    <div id="ar-scene-container">
        <a-scene 
            id="main-scene"
            embedded 
            arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
            vr-mode-ui="enabled: false"
            renderer="antialias: true; alpha: true; colorManagement: true;">
            
            <a-light type="ambient" intensity="1.2"></a-light>
            
            <a-entity id="content-anchor" position="0 0 -2"></a-entity> <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>
        </a-scene>
    </div>

    <button id="enter-ar-btn" class="btn-primary hidden">
        <span>ورود به AR (قدم زدن)</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a.5.5 0 0 1 .5.5V6h-1V1.5a.5.5 0 0 1 .5-.5zm0 14a.5.5 0 0 1-.5-.5V10h1v4.5a.5.5 0 0 1-.5.5zM2 7a1 1 0 0 1 .5-.5H8v1H2.5A.5.5 0 0 1 2 7zm12 0a.5.5 0 0 1-.5.5H8V6h5.5a1 1 0 0 1 .5.5z"/></svg>
    </button>

    <div id="ui-layer">
        <div class="top-bar pointer-events-auto">
            <button id="back-btn" class="btn-icon" style="background:rgba(220,38,38,0.8)"><svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg></button>
            <div style="display:flex; gap:10px;">
                <button id="reset-btn" class="btn-icon" title="Reset"><svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
            </div>
        </div>

        <div class="bottom-controls pointer-events-auto">
            <label class="btn-primary" style="cursor: pointer;">
                <span>انتخاب فایل</span>
                <input type="file" id="file-input" accept="image/*,video/*" style="display:none">
            </label>

            <div id="ar-controls" class="slider-container hidden">
                <span style="font-size:12px; color:#fbbf24; white-space:nowrap;">فاصله:</span>
                <input type="range" id="dist-slider" min="0.5" max="5" step="0.1" value="2">
            </div>
            
            <div id="video-controls" class="slider-container hidden">
                 <button id="play-pause-btn" class="btn-icon" style="width:30px; height:30px;"><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/></svg></button>
                 <input type="range" id="seek-bar" value="0" min="0" step="0.1">
            </div>
        </div>
    </div>

    <script>
        // متغیرهای اصلی
        let currentFileType = null;
        let currentFileUrl = null;
        let isArActive = false;
        let currentMesh = null;
        
        // المان‌های DOM
        const body = document.getElementById('app-body');
        const fileInput = document.getElementById('file-input');
        const imgPreview = document.getElementById('img-preview');
        const videoPreview = document.getElementById('video-preview');
        const placeholderText = document.getElementById('placeholder-text');
        const enterArBtn = document.getElementById('enter-ar-btn');
        const arControls = document.getElementById('ar-controls');
        const videoControls = document.getElementById('video-controls');
        const contentAnchor = document.getElementById('content-anchor');
        const distSlider = document.getElementById('dist-slider');
        const backBtn = document.getElementById('back-btn');
        const sceneEl = document.querySelector('a-scene');

        // 1. انتخاب فایل
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            currentFileUrl = URL.createObjectURL(file);
            currentFileType = file.type.startsWith('video') ? 'video' : 'image';

            // نمایش در حالت غیر AR
            placeholderText.style.display = 'none';
            if (currentFileType === 'image') {
                imgPreview.src = currentFileUrl;
                imgPreview.classList.remove('hidden');
                videoPreview.classList.add('hidden');
                videoPreview.pause();
                videoControls.classList.add('hidden');
            } else {
                videoPreview.src = currentFileUrl;
                videoPreview.classList.remove('hidden');
                imgPreview.classList.add('hidden');
                videoPreview.play();
                videoControls.classList.remove('hidden');
            }

            // دکمه ورود به AR فعال شود
            enterArBtn.classList.remove('hidden');
        });

        // 2. ورود به حالت AR
        enterArBtn.addEventListener('click', () => {
            if (!currentFileUrl) return;

            isArActive = true;
            body.classList.add('ar-active'); // این کلاس دوربین را روشن و UI غیر AR را مخفی می‌کند
            enterArBtn.style.display = 'none';
            arControls.classList.remove('hidden');
            
            // متوقف کردن ویدیو پیش‌نمایش تا صدا دوتا نشود
            if(currentFileType === 'video') {
                videoPreview.pause();
            }

            createArContent();
            
            // درخواست فول اسکرین
            if(document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }
        });

        // 3. خروج از حالت AR (برگشت به حالت عادی)
        backBtn.addEventListener('click', () => {
            if (isArActive) {
                exitArMode();
            } else {
                // اگر در حالت عادی بودیم و بک زدیم، از برنامه خارج شود (یا رفرش)
                window.history.back();
            }
        });

        function exitArMode() {
            isArActive = false;
            body.classList.remove('ar-active'); // دوربین مخفی می‌شود
            enterArBtn.style.display = 'flex';
            arControls.classList.add('hidden');
            
            // پاک کردن محتوای سه بعدی
            while(contentAnchor.firstChild){
                contentAnchor.removeChild(contentAnchor.firstChild);
            }
            currentMesh = null;

            // بازگشت به حالت پیش‌نمایش
            if(currentFileType === 'video') {
                videoPreview.play();
            }
        }

        // 4. ساخت محتوای سه بعدی برای A-Frame
        function createArContent() {
            // پاک کردن قبلی‌ها
            while(contentAnchor.firstChild){
                contentAnchor.removeChild(contentAnchor.firstChild);
            }

            // فاصله پیش‌فرض
            distSlider.value = 2;
            contentAnchor.object3D.position.z = -2;

            if (currentFileType === 'image') {
                // محاسبه نسبت تصویر برای جلوگیری از کشیدگی
                const img = new Image();
                img.src = currentFileUrl;
                img.onload = () => {
                    const aspect = img.width / img.height;
                    const el = document.createElement('a-plane');
                    el.setAttribute('src', currentFileUrl);
                    el.setAttribute('width', aspect); // عرض بر اساس نسبت
                    el.setAttribute('height', 1);
                    el.setAttribute('side', 'double');
                    el.setAttribute('transparent', 'true');
                    contentAnchor.appendChild(el);
                    currentMesh = el;
                };
            } else {
                // ویدیو نیاز به تعریف a-video و asset دارد اما برای سادگی و سرعت:
                // مستقیم از المان ویدیو DOM استفاده می‌کنیم
                // اما چون ویدیو preview مخفی شده، یک المان ویدیو جدید برای تکسچر می‌سازیم
                
                const vidEl = document.createElement('video');
                vidEl.src = currentFileUrl;
                vidEl.id = 'ar-video-texture';
                vidEl.autoplay = true;
                vidEl.loop = true;
                vidEl.playsInline = true;
                vidEl.muted = false; // صدا در AR پخش شود
                vidEl.crossOrigin = "anonymous";
                vidEl.style.display = 'none';
                document.body.appendChild(vidEl);
                vidEl.play();

                // صبر برای لود متادیتا جهت نسبت تصویر
                vidEl.addEventListener('loadedmetadata', () => {
                    const aspect = vidEl.videoWidth / vidEl.videoHeight;
                    const el = document.createElement('a-video');
                    el.setAttribute('src', '#ar-video-texture'); // اشاره به آیدی ویدیو
                    el.setAttribute('width', aspect);
                    el.setAttribute('height', 1);
                    el.setAttribute('side', 'double');
                    contentAnchor.appendChild(el);
                    currentMesh = el;
                    
                    // سینک کردن سیک‌بار (ساده)
                    const playBtn = document.getElementById('play-pause-btn');
                    const seek = document.getElementById('seek-bar');
                    seek.max = vidEl.duration;
                    
                    playBtn.onclick = () => {
                        if(vidEl.paused) vidEl.play(); else vidEl.pause();
                    };
                    
                    vidEl.ontimeupdate = () => {
                        seek.value = vidEl.currentTime;
                    };
                    
                    seek.oninput = () => {
                        vidEl.currentTime = seek.value;
                    };
                });
            }
        }

        // کنترل فاصله در AR
        distSlider.addEventListener('input', (e) => {
            const val = -parseFloat(e.target.value);
            contentAnchor.object3D.position.z = val;
        });

        // دکمه ریست
        document.getElementById('reset-btn').addEventListener('click', () => {
             distSlider.value = 2;
             contentAnchor.object3D.position.set(0, 0, -2);
             contentAnchor.object3D.rotation.set(0, 0, 0);
             if(currentMesh) currentMesh.object3D.scale.set(1, 1, 1);
        });

        // هندل کردن تاچ برای چرخش و زوم (ساده شده برای A-Frame)
        // چون A-Frame خودش Look-controls دارد برای دوربین،
        // ما اینجا تاچ را برای خود آبجکت (مس) پیاده می‌کنیم
        
        let initialScale = 1;
        let initialTouchDist = 0;
        
        document.addEventListener('touchstart', (e) => {
            if(!isArActive || !currentMesh) return;
            if(e.touches.length === 2) {
                const dx = e.touches[0].pageX - e.touches[1].pageX;
                const dy = e.touches[0].pageY - e.touches[1].pageY;
                initialTouchDist = Math.sqrt(dx*dx + dy*dy);
                initialScale = currentMesh.object3D.scale.x;
            }
        });

        document.addEventListener('touchmove', (e) => {
            if(!isArActive || !currentMesh) return;
            if(e.touches.length === 2) {
                const dx = e.touches[0].pageX - e.touches[1].pageX;
                const dy = e.touches[0].pageY - e.touches[1].pageY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                const factor = dist / initialTouchDist;
                const newScale = initialScale * factor;
                currentMesh.object3D.scale.set(newScale, newScale, 1);
            }
        });

    </script>
</body>
</html>