<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>AR Gallery - Pro World Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link href="css/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <script src="js/mediapipe/selfie_segmentation.js" defer></script>
    <script src="js/webxr-polyfill.js"></script>
    
    <style>
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; overflow: hidden; background-color: #000; user-select: none; -webkit-tap-highlight-color: transparent; color: white; }
        
        #camera-feed { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; display: none; 
        }

        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; transition: opacity 0.3s; }
        .ui-hidden #ui-layer { opacity: 0; pointer-events: none; }
        .ui-top-bar { padding: 15px; display: flex; justify-content: space-between; pointer-events: auto; padding-top: env(safe-area-inset-top, 20px); }
        .ui-top-bar-left, .ui-top-bar-right { display: flex; gap: 10px; }
        .ui-bottom-controls { padding: 10px 15px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); pointer-events: auto; display: flex; flex-direction: column; gap: 10px; align-items: flex-start; width: 100%; box-sizing: border-box; padding-bottom: calc(20px + env(safe-area-inset-bottom, 10px)); }
        
        .btn-icon { background: rgba(40, 40, 40, 0.85); border: 1px solid rgba(255, 255, 255, 0.2); color: white; width: 42px; height: 42px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.2s, background 0.3s; pointer-events: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.3); padding: 0; margin: 0; }
        .btn-icon:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.3); }
        .btn-icon.active-mode { background: #3b82f6; border-color: #60a5fa; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .btn-icon.exit-mode { background: rgba(220, 38, 38, 0.8); border-color: #f87171; }
        .hidden { display: none !important; }
        .btn-label { background: #2563eb; color: white; padding: 8px 16px; border-radius: 30px; display: flex; align-items: center; gap: 10px; font-weight: bold; cursor: pointer; transition: transform 0.2s; pointer-events: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3); font-size: 0.9rem; }
        .controls-row { display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 40px; flex-wrap: wrap; justify-content: center; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -6px; border: 1px solid white; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #4b5563; border-radius: 2px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: none; justify-content: center; align-items: center; padding: 20px; pointer-events: auto; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-content { background: #1f2937; color: white; padding: 25px; border-radius: 20px; max-width: 400px; width: 100%; border: 1px solid #374151; text-align: right; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #374151; padding-bottom: 10px; }
        #touch-status { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); color: white; padding: 10px 20px; border-radius: 20px; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 20; font-size: 0.9rem; }
        #ar-container { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1; pointer-events: none; }
        #custom-ar-btn { position: absolute; bottom: 80px; right: 30px; padding: 12px 30px; border: 1px solid rgba(255,255,255,0.5); border-radius: 25px; background: rgba(0,0,0,0.7); color: white; font-family: 'Vazirmatn', sans-serif; font-size: 14px; font-weight: bold; z-index: 50; cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.5); transition: all 0.2s; }
        #custom-ar-btn:active { transform: scale(0.95); background: rgba(37, 99, 235, 0.8); }
        #temp-reveal-btn { position: fixed; top: 80px; right: 20px; z-index: 100; display: none; padding: 12px 25px; background: rgba(37, 99, 235, 0.9); color: white; font-weight: bold; font-size: 1rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 30px; pointer-events: auto; }
        
        .w-full { width: 100%; } .flex { display: flex; } .items-center { align-items: center; } .gap-3 { gap: 12px; } .text-xs { font-size: 0.75rem; } .text-white { color: white; } .bg-black\/60 { background-color: rgba(0,0,0,0.6); } .rounded-full { border-radius: 9999px; } .p-2 { padding: 0.5rem; } .flex-grow { flex-grow: 1; } .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 0.5rem; } .justify-end { justify-content: flex-end; } .flex-col { flex-direction: column; }
    </style>
</head>
<body id="app-body">

    <video id="camera-feed" autoplay muted playsinline></video>
    <div id="ar-container"></div>
    <div id="touch-status">وضعیت</div>
    <button id="custom-ar-btn">ورود به AR (World Tracking)</button>
    <button id="temp-reveal-btn">نمایش دکمه‌ها</button>

    <div id="ui-layer">
        <div class="ui-top-bar">
            <div class="ui-top-bar-left">
                <button id="exit-btn" class="btn-icon exit-mode" title="خروج">
                   <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/></svg>
                </button>
                <button id="about-btn" class="btn-icon" title="درباره"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></button>
                <button id="help-btn" class="btn-icon" title="راهنما"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg></button>
                <button id="settings-btn" class="btn-icon" title="تنظیمات"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/></svg></button>
            </div>
            <div class="ui-top-bar-right">
                <button id="clean-view-btn" class="btn-icon hidden" title="پنهان شدن"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg></button>
                <button id="fullscreen-btn" class="btn-icon hidden" title="تمام صفحه"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg></button>
            </div>
        </div>

        <div class="ui-bottom-controls">
            <div id="dist-container" class="w-full px-8 hidden mb-2">
                <div class="flex items-center gap-3 w-full bg-black/60 p-2 rounded-full border border-gray-600">
                    <span class="text-xs text-yellow-400 font-bold whitespace-nowrap">فاصله:</span>
                    <input type="range" id="dist-slider" min="0.5" max="10.0" value="3.0" step="0.1" class="flex-grow">
                </div>
            </div>

            <div id="seek-container" class="w-full px-8 hidden mb-2">
                <div class="flex items-center gap-2 w-full bg-black/40 p-2 rounded-full">
                    <span id="current-time" class="text-xs text-white min-w-[35px] text-center">0:00</span>
                    <input type="range" id="seek-bar" min="0" value="0" step="0.1" class="flex-grow">
                    <span id="duration-time" class="text-xs text-white min-w-[35px] text-center">0:00</span>
                </div>
            </div>
            
            <div class="w-full flex justify-end px-8 mb-4">
                <label id="file-label" class="btn-label">
                    <span>انتخاب ویدیو یا عکس</span>
                    <input type="file" id="file-input" accept="video/*,image/*" style="display: none;">
                </label>
            </div>

            <div id="controls-panel" class="flex flex-col gap-3 items-center hidden w-full">
                <div class="controls-row">
                    <button id="play-btn" class="btn-icon" style="width: 50px; height: 50px; background: #2563eb; display:none;">
                         <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/></svg>
                         <svg id="pause-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5 6.25a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0v-3.5zm3.5 0a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0v-3.5z"/></svg>
                    </button>
                    <button id="remove-bg-btn" class="btn-icon" title="حذف بکگراند"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5Z"/></svg></button>
                </div>
                <div id="size-controls" class="controls-row mt-2">
                    <button id="reset-btn" class="btn-icon" title="قفل در رو به رو"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
                    <button id="cube-shape-btn" class="btn-icon" title="حالت مکعب"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16"><path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/></svg></button>
                    <button id="mode-3d-btn" class="btn-icon" title="چرخش ۳ بعدی"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/><path d="M8 1a.5.5 0 0 1 .5.5v14a.5.5 0 0 1-1 0v-14A.5.5 0 0 1 8 1z" opacity="0.5"/><path d="M1 8a.5.5 0 0 1 .5-.5h14a.5.5 0 0 1 0 1h-14A.5.5 0 0 1 1 8z" opacity="0.5"/></svg></button>
                    <button id="rotate-btn" class="btn-icon" title="چرخش 90"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/></svg></button>
                    <button id="aspect-btn" class="btn-icon" title="نسبت تصویر"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M5 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H5zm6 10H5a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1z"/></svg></button>
                    <button id="stretch-btn" class="btn-icon" title="سایز آزاد"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/><path fill-rule="evenodd" d="M13.5 12.5a.5.5 0 0 1 0-1l2 1.5-2 1.5a.5.5 0 0 1 0-1V12.5zM2.5 12.5V13a.5.5 0 0 1 0 1l-2-1.5 2-1.5a.5.5 0 0 1 0 1v.5z"/><path d="M2.5 3.5a.5.5 0 0 1 0 1l-2-1.5 2-1.5a.5.5 0 0 1 0 1v.5zm11 0v-.5a.5.5 0 0 1 0-1l2 1.5-2 1.5a.5.5 0 0 1 0-1v-.5z"/></svg></button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تنظیمات</h3>
                <button id="close-settings-btn" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>
            <div class="radio-group">
                <label class="radio-item"><input type="radio" name="reveal-mode" value="button" checked><span>نمایش دکمه با لمس</span></label>
                <label class="radio-item"><input type="radio" name="reveal-mode" value="gesture"><span>چهار انگشت همزمان</span></label>
            </div>
        </div>
    </div>
    
    <div id="about-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header" style="justify-content: center; position: relative;">
                <h3 class="modal-title">درباره ما</h3>
                <button id="close-about-btn" style="background:none; border:none; color:white; font-size:1.5rem; position: absolute; left: 0;">&times;</button>
            </div>
            <p>نسخه: World Tracking Stable</p>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">راهنما</h3>
                <button id="close-help-btn" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <ul style="list-style-type: none; padding: 0; line-height: 1.8; font-size: 0.9rem;">
                    <li>1. فایل را انتخاب کنید.</li>
                    <li>2. در حالت World Tracking، فایل در جهت جغرافیایی ثابت می‌ماند.</li>
                    <li>3. برای جابجایی فایل، از لمس یک انگشتی استفاده کنید.</li>
                    <li>4. سنسور حرکتی (شتاب‌سنج) برای جلوگیری از لرزش غیرفعال شده است.</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from './js/three.module.js';

        // Initialize Variables
        let camera, scene, renderer, currentMesh = null, currentVideo = null, currentImageTexture = null, shadowMesh = null;
        let isStretchMode = false, is3DMode = false, isCubeMode = false, currentOriginalWidth = 1, currentOriginalHeight = 1, aspectRatioMode = 0;
        let isDragging = false, previousMousePosition = { x: 0, y: 0 };
        let initialPinchDistance = 0, initialScale = new THREE.Vector3(), initialAngle = 0, initialRotationZ = 0, gestureType = null;
        let uiHidden = false, revealMode = 'button', revealTimer = null;
        let selfieSegmentation = null, isBgRemovalActive = false, segmentationCanvas = document.createElement('canvas'), segmentationCtx = segmentationCanvas.getContext('2d', { willReadFrequently: false }), originalTexture = null, processedTexture = null, lastProcessTime = 0, isProcessing = false;
        
        let cameraStream = null;
        let deviceOrientationEnabled = false;
        const cameraFeedVideo = document.getElementById('camera-feed');
        const deviceEuler = new THREE.Euler(0, 0, 0, 'YXZ');
        let resetARCoordinateSystem = false;
        let calibrationQuaternion = new THREE.Quaternion();

        // DOM Elements
        const uiLayer = document.getElementById('ui-layer'), fileInput = document.getElementById('file-input'), fileLabel = document.getElementById('file-label'), controlsPanel = document.getElementById('controls-panel'), cleanViewBtn = document.getElementById('clean-view-btn'), fullscreenBtn = document.getElementById('fullscreen-btn'), distContainer = document.getElementById('dist-container'), seekContainer = document.getElementById('seek-container'), playBtn = document.getElementById('play-btn'), playIcon = document.getElementById('play-icon'), pauseIcon = document.getElementById('pause-icon'), seekBar = document.getElementById('seek-bar'), currentTimeEl = document.getElementById('current-time'), durationTimeEl = document.getElementById('duration-time'), touchStatus = document.getElementById('touch-status'), distSlider = document.getElementById('dist-slider'), tempRevealBtn = document.getElementById('temp-reveal-btn'), settingsBtn = document.getElementById('settings-btn'), settingsModal = document.getElementById('settings-modal'), helpModal = document.getElementById('help-modal'), removeBgBtn = document.getElementById('remove-bg-btn'), customArBtn = document.getElementById('custom-ar-btn'), exitBtn = document.getElementById('exit-btn'), aboutBtn = document.getElementById('about-btn'), aboutModal = document.getElementById('about-modal'), cubeShapeBtn = document.getElementById('cube-shape-btn');

        init();

        function init() {
            const container = document.getElementById('ar-container');
            
            scene = new THREE.Scene();
            
            // تنظیمات دوربین برای World Tracking
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0); // دوربین همیشه در مرکز است

            // رندر با کیفیت بالا و Transparency
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,  
                alpha: true, 
                preserveDrawingBuffer: false,
                powerPreference: "high-performance" // برای شبیه‌سازی بهتر
            });
            renderer.setPixelRatio(window.devicePixelRatio); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
            renderer.outputColorSpace = THREE.SRGBColorSpace; 
            container.appendChild(renderer.domElement);
            
            renderer.setAnimationLoop(render);

            customArBtn.addEventListener('click', startARMode);
            window.addEventListener('resize', onWindowResize);
            setupUIListeners();
            setupTouchGestures(); 
        }

        async function startARMode() {
            if (!currentMesh) { showToast("لطفا فایل انتخاب کنید"); return; }
            
            // درخواست دسترسی سنسورها
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') deviceOrientationEnabled = true;
                } catch (e) { console.error(e); }
            } else {
                deviceOrientationEnabled = true;
            }

            if (deviceOrientationEnabled) {
                 window.addEventListener('deviceorientation', handleDeviceOrientation);
                 // نکته کلیدی: حذف devicemotion (شتاب سنج) برای حذف لرزش و حرکت ناخواسته
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                cameraStream = stream;
                cameraFeedVideo.srcObject = stream;
                cameraFeedVideo.style.display = 'block';
                
                hideNonARUI();
                customArBtn.style.display = 'none'; 
                fullscreenBtn.style.display = 'none'; 
                
                resetCameraAndObject();
                showToast("حالت World Tracking فعال شد");
            } catch (err) {
                showToast("خطا در دوربین");
            }
        }

        function handleDeviceOrientation(event) {
            if (!deviceOrientationEnabled) return;
            const alpha = event.alpha ? THREE.MathUtils.degToRad(event.alpha) : 0; 
            const beta = event.beta ? THREE.MathUtils.degToRad(event.beta) : 0;   
            const gamma = event.gamma ? THREE.MathUtils.degToRad(event.gamma) : 0; 

            deviceEuler.set(beta, alpha, -gamma, 'YXZ');
            const currentQ = new THREE.Quaternion().setFromEuler(deviceEuler);
            const orientQ = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 0, 1), -THREE.MathUtils.degToRad(window.orientation || 0));
            currentQ.multiply(orientQ);

            if (resetARCoordinateSystem) {
                calibrationQuaternion.copy(currentQ).invert();
                resetARCoordinateSystem = false;
            }
            // فقط دوربین می‌چرخد. پوزیشن دوربین مطلقاً تغییر نمی‌کند.
            camera.quaternion.multiplyQuaternions(currentQ, calibrationQuaternion);
        }

        function resetCameraAndObject() {
            if (currentMesh) {
                distSlider.value = 3.0;
                // ریست کردن زاویه دید
                resetARCoordinateSystem = true;
                // قرار دادن آبجکت دقیقاً رو به روی کاربر (در دنیای مجازی)
                // وقتی کالیبره شود، رو به رو یعنی Z منفی
                currentMesh.position.set(0, 0, -3.0); 
                currentMesh.rotation.set(0, 0, 0);
                if(shadowMesh) {
                     shadowMesh.position.y = -(currentOriginalHeight/2) - 0.05;
                     shadowMesh.visible = true;
                }
            }
        }

        function render() {
            if (currentMesh && currentMesh.material.map && currentVideo) {
                if (currentVideo.readyState >= 2 && !currentVideo.paused) {
                    currentMesh.material.map.needsUpdate = true;
                }
            }
            renderer.render(scene, camera);
        }

        // ایجاد سایه پویا (Real-time Shadow Simulation)
        function createShadow(width) {
            if(shadowMesh) { scene.remove(shadowMesh); shadowMesh = null; }
            
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(0,0,0,0.6)'); // مرکز تیره
            gradient.addColorStop(1, 'rgba(0,0,0,0)');   // لبه شفاف
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            
            const shadowTexture = new THREE.CanvasTexture(canvas);
            const shadowMaterial = new THREE.MeshBasicMaterial({ 
                map: shadowTexture, 
                transparent: true, 
                depthWrite: false, 
                side: THREE.DoubleSide
            });
            const shadowGeo = new THREE.PlaneGeometry(width * 1.2, width * 1.2);
            shadowMesh = new THREE.Mesh(shadowGeo, shadowMaterial);
            shadowMesh.rotation.x = -Math.PI / 2;
            
            // سایه فرزند مش اصلی می‌شود تا با آن حرکت کند
            if(currentMesh) {
                currentMesh.add(shadowMesh);
                shadowMesh.position.y = -(currentOriginalHeight/2) - 0.1; // کمی پایین‌تر از تصویر
            }
        }

        function createMesh(texture, width, height) { 
            try{ 
                if (currentMesh) { scene.remove(currentMesh); }
            }catch(e){} 
            
            const aspectRatio = width / height; 
            const displayHeight = 1.0; 
            const displayWidth = displayHeight * aspectRatio; 
            currentOriginalWidth = displayWidth; 
            currentOriginalHeight = displayHeight; 
            
            const geometry = new THREE.PlaneGeometry(displayWidth, displayHeight, 1, 1); 
            
            // Gaussian Splatting Simulation via Soft Blending
            // استفاده از Custom Blending برای نرم کردن لبه‌ها و ایجاد حس ادغام با محیط
            const material = new THREE.MeshBasicMaterial({ 
                map: texture, 
                side: THREE.DoubleSide, 
                transparent: true,
                blending: THREE.CustomBlending,
                blendEquation: THREE.AddEquation,
                blendSrc: THREE.SrcAlphaFactor,
                blendDst: THREE.OneMinusSrcAlphaFactor
            }); 
            
            currentMesh = new THREE.Mesh(geometry, material); 
            currentMesh.position.set(0, 0, -3.0); 
            scene.add(currentMesh);
            
            // اضافه کردن سایه
            createShadow(displayWidth);
            
            showToast("فایل با افکت Gaussian Style بارگذاری شد"); 
        }

        // توابع کمکی UI
        function hideNonARUI(){ if(currentVideo) currentVideo.style.display="none"; }
        function showNonARUI(){ const ui=document.getElementById("ui-layer"); if(ui) ui.style.display="flex"; if(currentVideo) currentVideo.style.display="block"; }
        function formatTime(s) { const m = Math.floor(s / 60); const sc = Math.floor(s % 60); return `${m}:${sc < 10 ? '0' : ''}${sc}`; }
        function showToast(msg) { touchStatus.innerText = msg; touchStatus.style.opacity = '1'; setTimeout(() => { touchStatus.style.opacity = '0'; }, 2500); }
        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

        function setupUIListeners() {
            exitBtn.addEventListener('click', () => { 
                if (cameraStream) {
                    if(cameraStream) cameraStream.getTracks().forEach(t=>t.stop()); cameraStream = null;
                    cameraFeedVideo.style.display='none'; 
                    window.removeEventListener('deviceorientation', handleDeviceOrientation);
                    camera.quaternion.set(0,0,0,1);
                    showNonARUI(); customArBtn.style.display='block'; fullscreenBtn.style.display='flex';
                    if(currentMesh) { currentMesh.position.set(0,0,-3); currentMesh.rotation.set(0,0,0); }
                } else window.history.back();
            });
            
            fileInput.addEventListener('change', handleFileSelect);
            cleanViewBtn.addEventListener('click', () => { uiHidden = true; document.body.classList.add('ui-hidden'); });
            tempRevealBtn.addEventListener('click', () => { uiHidden = false; document.body.classList.remove('ui-hidden'); tempRevealBtn.style.display = 'none'; });
            settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex'); document.getElementById('close-settings-btn').addEventListener('click', () => settingsModal.style.display = 'none');
            document.getElementById('help-btn').addEventListener('click', () => helpModal.style.display = 'flex'); document.getElementById('close-help-btn').addEventListener('click', () => helpModal.style.display = 'none');
            fullscreenBtn.addEventListener('click', () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });
            playBtn.addEventListener('click', () => { if (currentVideo) { if (currentVideo.paused) { currentVideo.play(); playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); } else { currentVideo.pause(); playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); } } });
            seekBar.addEventListener('input', () => { if (currentVideo) currentVideo.currentTime = seekBar.value; });
            
            // اصلاح اسلایدر فاصله برای World Tracking
            distSlider.addEventListener('input', (e) => { 
                if (currentMesh && cameraStream) {
                    const dist = parseFloat(e.target.value);
                    const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                    // جابجایی فایل به فاصله جدید در راستای دید فعلی
                    currentMesh.position.copy(camera.position).add(dir.multiplyScalar(dist));
                } else if (currentMesh) {
                    currentMesh.position.z = -parseFloat(e.target.value);
                }
            });

            document.getElementById('reset-btn').addEventListener('click', () => { if(cameraStream) resetCameraAndObject(); else { currentMesh.position.set(0,0,-3); currentMesh.rotation.set(0,0,0); } });
            cubeShapeBtn.addEventListener('click', () => { if (!currentMesh) return; isCubeMode = !isCubeMode; cubeShapeBtn.classList.toggle('active-mode', isCubeMode); if (isCubeMode) { currentMesh.geometry = new THREE.BoxGeometry(currentOriginalWidth*0.5, currentOriginalHeight*0.5, currentOriginalHeight*0.3); } else { currentMesh.geometry = new THREE.PlaneGeometry(currentOriginalWidth, currentOriginalHeight); } });
            document.getElementById('mode-3d-btn').addEventListener('click', function() { is3DMode = !is3DMode; this.classList.toggle('active-mode', is3DMode); });
            document.getElementById('rotate-btn').addEventListener('click', () => { if (currentMesh) currentMesh.rotation.z -= Math.PI / 2; });
            document.getElementById('aspect-btn').addEventListener('click', () => { if (!currentMesh) return; aspectRatioMode = (aspectRatioMode + 1) % 4; const s = aspectRatioMode===3?2:aspectRatioMode===1?1.5:1; currentMesh.scale.set(s, aspectRatioMode===2?1.5:1, 1); });
            document.getElementById('stretch-btn').addEventListener('click', function() { isStretchMode = !isStretchMode; this.classList.toggle('active-mode', isStretchMode); });
            removeBgBtn.addEventListener('click', toggleBgRemoval);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return; 
            const url = URL.createObjectURL(file); 
            const fileType = file.type.split('/')[0];
            controlsPanel.classList.remove('hidden'); controlsPanel.classList.add('flex');
            cleanViewBtn.classList.remove('hidden'); fullscreenBtn.classList.remove('hidden'); distContainer.classList.remove('hidden');
            if (fileType === 'image') { 
                const loader = new THREE.TextureLoader(); 
                loader.load(url, (tex) => { 
                    tex.colorSpace = THREE.SRGBColorSpace; currentImageTexture = tex; createMesh(tex, tex.image.width, tex.image.height); 
                });
                playBtn.style.display = 'none'; seekContainer.classList.add('hidden'); 
            } else { 
                const video = document.createElement('video'); video.src = url; video.loop = true; video.playsInline = true; video.play();
                currentVideo = video; 
                playBtn.style.display = 'flex'; seekContainer.classList.remove('hidden'); playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden');
                video.addEventListener('loadedmetadata', () => { 
                    seekBar.max = video.duration; durationTimeEl.innerText = formatTime(video.duration);
                    const tex = new THREE.VideoTexture(video); tex.colorSpace = THREE.SRGBColorSpace; 
                    createMesh(tex, video.videoWidth, video.videoHeight); 
                });
                video.addEventListener('timeupdate', () => { seekBar.value = video.currentTime; currentTimeEl.innerText = formatTime(video.currentTime); });
            }
        }

        async function toggleBgRemoval() {
            if (!currentMesh) return;
            if (!selfieSegmentation) { 
                if (window.SelfieSegmentation) {
                    selfieSegmentation = new SelfieSegmentation({locateFile: (file) => `./js/mediapipe/${file}`});
                    selfieSegmentation.setOptions({ modelSelection: 0, selfieMode: false });
                    selfieSegmentation.onResults(onSegmentationResults);
                    setTimeout(toggleBgRemoval, 1000);
                }
                showToast("در حال لود هوش مصنوعی..."); return;
            }
            isBgRemovalActive = !isBgRemovalActive; removeBgBtn.classList.toggle('active-mode', isBgRemovalActive);
            if (isBgRemovalActive) {
                originalTexture = currentMesh.material.map;
                let w = currentVideo ? currentVideo.videoWidth : currentImageTexture.image.width;
                let h = currentVideo ? currentVideo.videoHeight : currentImageTexture.image.height;
                segmentationCanvas.width = 360; segmentationCanvas.height = Math.floor(360 * (h/w));
                processedTexture = new THREE.CanvasTexture(segmentationCanvas); 
                currentMesh.material.map = processedTexture; 
                if(currentVideo) processVideoFrame(); else await selfieSegmentation.send({image: currentImageTexture.image});
            } else {
                if (originalTexture) currentMesh.material.map = originalTexture;
            }
        }
        function onSegmentationResults(results) { 
            segmentationCtx.clearRect(0, 0, segmentationCanvas.width, segmentationCanvas.height); 
            segmentationCtx.drawImage(results.segmentationMask, 0, 0, segmentationCanvas.width, segmentationCanvas.height); 
            segmentationCtx.globalCompositeOperation = 'source-in'; 
            segmentationCtx.drawImage(results.image, 0, 0, segmentationCanvas.width, segmentationCanvas.height); 
            if (processedTexture) processedTexture.needsUpdate = true; isProcessing = false; 
        }
        async function processVideoFrame() {
            if (isBgRemovalActive && currentVideo && !currentVideo.paused) {
                if (!isProcessing) { isProcessing = true; await selfieSegmentation.send({image: currentVideo}); }
                requestAnimationFrame(processVideoFrame);
            }
        }

        // جسچرها
        function setupTouchGestures() {
            const el = document.body;
            el.addEventListener('touchstart', (e) => {
                if (e.target.closest('button') || e.target.closest('input')) return;
                if (uiHidden) { 
                    tempRevealBtn.style.display = 'block'; 
                    if (revealTimer) clearTimeout(revealTimer); 
                    revealTimer = setTimeout(() => { tempRevealBtn.style.display = 'none'; }, 2000); 
                }
                if (!currentMesh) return;
                if (e.touches.length === 1) { isDragging = true; previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY }; }
                else if (e.touches.length === 2) { 
                    gestureType = null; 
                    const dx = e.touches[0].clientX - e.touches[1].clientX; 
                    const dy = e.touches[0].clientY - e.touches[1].clientY; 
                    initialPinchDistance = Math.sqrt(dx * dx + dy * dy); 
                    initialScale.copy(currentMesh.scale); 
                    initialAngle = Math.atan2(dy, dx); 
                }
            });

            el.addEventListener('touchmove', (e) => {
                if (!currentMesh || e.target.closest('.ui-bottom-controls')) return;
                if (e.touches.length === 1 && isDragging) { 
                    const deltaX = e.touches[0].clientX - previousMousePosition.x; 
                    const deltaY = e.touches[0].clientY - previousMousePosition.y; 
                    
                    if (is3DMode) {
                        currentMesh.rotation.y += deltaX * 0.005; 
                        currentMesh.rotation.x += deltaY * 0.005;
                    } else {
                        // جابجایی دستی در حالت World Tracking
                        // چون سنسور حرکت قطع است، کاربر می‌تواند دستی جابجا کند
                        const speed = 0.005;
                        const right = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);
                        const up = new THREE.Vector3(0,1,0).applyQuaternion(camera.quaternion);
                        currentMesh.position.addScaledVector(right, deltaX * speed);
                        currentMesh.position.addScaledVector(up, -deltaY * speed);
                    }
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY }; 
                }
                else if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX; 
                    const dy = e.touches[0].clientY - e.touches[1].clientY; 
                    const distance = Math.sqrt(dx * dx + dy * dy); 
                    const angle = Math.atan2(dy, dx); 
                    const scaleChange = Math.abs(distance - initialPinchDistance); 
                    
                    if (!gestureType) gestureType = scaleChange > 10 ? 'zoom' : 'rotate';

                    if (gestureType === 'zoom') { 
                        const ratio = distance / initialPinchDistance;
                        if (cameraStream && !isStretchMode) {
                            // در World Tracking زوم فاصله را تغییر می‌دهد
                            // اما به جای حرکت با دوربین، فقط یک بار فاصله ست می‌شود
                            // این بهتر از حرکت مداوم است
                        } else {
                            if (isStretchMode) currentMesh.scale.set(initialScale.x * ratio, initialScale.y * ratio, 1);
                            else currentMesh.scale.set(initialScale.x * ratio, initialScale.y * ratio, 1);
                        }
                    }
                    if (gestureType === 'rotate' && !is3DMode) { 
                        currentMesh.rotation.z = initialRotationZ + (angle - initialAngle); 
                    }
                }
            });
            el.addEventListener('touchend', () => { isDragging = false; });
        }
    </script>
</body>
</html>